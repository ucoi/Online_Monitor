name: OnlineSim Monitor

on:
  schedule:
    - cron: "*/5 * * * *" # every 5 minutes
  workflow_dispatch: {}

permissions:
  contents: write # needed to commit state files

jobs:
  run-monitor:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      - name: Run monitor (one-shot)
        env:
          ONLINESIM_API_KEY: ${{ secrets.ONLINESIM_API_KEY }}
          ONLINESIM_API_URL: ${{ secrets.ONLINESIM_API_URL || 'https://onlinesim.io/api' }}
          SERVICE: ${{ secrets.SERVICE || 'foodora' }}
          COUNTRY: ${{ secrets.COUNTRY || '36' }}
          EMAIL_ENABLED: "true"
          SMTP_SERVER: ${{ secrets.SMTP_SERVER || 'smtp.gmail.com' }}
          SMTP_PORT: ${{ secrets.SMTP_PORT || '587' }}
          SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
          SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
          RECIPIENT_EMAIL: ${{ secrets.RECIPIENT_EMAIL }}
          AUTO_PURCHASE: ${{ secrets.AUTO_PURCHASE || 'false' }}
          PURCHASE_QUANTITY: ${{ secrets.PURCHASE_QUANTITY || '2' }}
          COOLDOWN_AFTER_NOTIFICATION: ${{ secrets.COOLDOWN_AFTER_NOTIFICATION || '3600' }}
          RECHECK_INTERVAL_IF_STILL_AVAILABLE: ${{ secrets.RECHECK_INTERVAL_IF_STILL_AVAILABLE || '1800' }}
        run: |
          python monitor_one_shot.py
      - name: Commit state and purchases (if changed)
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add state.json purchased_numbers.json || true
          git diff --quiet --staged || (git commit -m "chore: update monitor state" && git push)
